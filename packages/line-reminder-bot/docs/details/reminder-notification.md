# リマインダー通知

## 概要

Cloudflare Workers Cron Triggersにより5分ごとに実行され、期限が来たリマインダーを取得してLINEにプッシュメッセージを送信します。通知後、該当リマインダーはDBから削除されます。

## エントリーポイント

- **トリガー**: Cron (`*/5 * * * *` - 5分ごと)

## データフロー

1. Cron Triggerが5分ごとに発火
2. `scheduled()` ハンドラーを実行
3. `processScheduledReminders()` を呼び出し
4. D1データベースから期限到達リマインダーを取得
5. 各リマインダーにLINEプッシュ通知を送信
6. 通知済みリマインダーをDBから削除

## 注意点

### 1. Cron実行頻度

- **設定**: `*/5 * * * *` (5分ごと)
- **実行タイミング**: 00:00, 00:05, 00:10, ..., 23:55
- **遅延**: 最大5分の遅延が発生する可能性

例：

- リマインダー実行予定: 14:32
- 実際の通知時刻: 14:35（次のCron実行時）

### 2. エラーハンドリング

個別のリマインダー処理はtry-catchで囲まれています。

**メリット**:

- 一部のリマインダーが失敗しても他は正常に送信される
- システム全体の可用性が向上

**デメリット**:

- 失敗したリマインダーはDBに残り続ける
- 次回のCron実行時に再試行される（リトライ機能として動作）

### 3. ctx.waitUntil()の使用

- Cloudflare Workersの実行時間制限を回避
- リクエストが完了した後も処理を継続
- 長時間実行される可能性のあるタスクに必須

### 4. 同じリマインダーの重複送信防止

- 削除が成功すれば次回のCron実行時には取得されない
- 削除が失敗した場合、次回のCron実行時に再送信される可能性
- 現在、重複送信防止メカニズムは実装されていない

### 5. タイムスタンプの精度

- ミリ秒単位で比較
- execution_timeもミリ秒単位で保存されている
- 精度は十分だが、Cron実行が5分ごとなので実質的な精度は5分
