# リマインダー一覧表示ロジック

## 概要

ユーザーがそのユーザーの全リマインダーを実行時刻順（近い順）に表示します。各リマインダーにはIDが表示され、後で個別操作（削除・更新）ができるようになります。

## エントリーポイント

- **ファイル**: [src/index.ts](../src/index.ts)
- **関数**: `fetch()` ハンドラー
- **トリガー**: LINE Messaging APIからのWebhook（テキストメッセージイベント）
- **判定条件**: メッセージが「一覧」「list」「リスト」のいずれかに完全一致（大文字小文字区別なし）

## データフロー

```text
User (LINE)
  │
  │ 1. メッセージ送信 ("一覧")
  ▼
LINE Messaging API
  │
  │ 2. Webhook POST
  ▼
Cloudflare Workers (index.ts)
  │
  │ 3. Webhook検証・ユーザー認証
  │    メッセージ判定（一覧コマンド？）
  ▼
reminderListUsecase.ts
  │
  │ 4. showReminderList()
  │    ↓
  │    getRemindersByUserId()
  ▼
D1 Database
  │
  │ 5. ユーザーのリマインダーを実行時刻昇順で取得
  ▼
reminderListUsecase.ts
  │
  │ 6. フォーマット（一覧メッセージ作成）
  │    - 実行時刻を日本時間で表示
  │    - 各リマインダーにIDを表示
  ▼
LINE API (Reply Message)
  │
  │ 7. 一覧メッセージを返信
  ▼
User (LINE)
```

## 主要関数

### `showReminderList()`

**場所**: [src/usecases/reminderListUsecase.ts](../src/usecases/reminderListUsecase.ts) (新規作成)

**責務**: ユーザーのリマインダー一覧を取得して表示

**パラメータ**:

- `userId`: LINEユーザーID
- `replyToken`: LINE返信用トークン
- `env`: 環境変数

**処理内容**:

1. `getRemindersByUserId()`でリマインダー一覧を取得
2. リマインダーが0件の場合、「リマインダーがありません」を返信
3. 各リマインダーを整形:
   - ID（最初の8文字）
   - 間隔ラベル
   - 実行時刻（日本時間）
   - メッセージ
4. `sendReplyToLine()`で一覧メッセージを返信

### `getRemindersByUserId()`

**場所**: [src/infrastructure/reminderRepository.ts:55](../src/infrastructure/reminderRepository.ts#L55) (既存)

**責務**: ユーザーのリマインダー一覧を取得（実行時刻昇順）

`user_id`でフィルタし、`execution_time`の昇順で返す。

**戻り値**: `Promise<Reminder[]>`

### `formatReminderList()`

**場所**: [src/usecases/reminderListUsecase.ts](../src/usecases/reminderListUsecase.ts) (新規作成)

**責務**: リマインダー配列を一覧表示用のテキストに整形

**処理内容**:

1. ヘッダー作成: `📋 あなたのリマインダー（全N件）`
2. 各リマインダーをループ:
   - ID短縮表示: `f47ac10b...` (最初の8文字)
   - 日時フォーマット: `12/25 14:35`
   - 間隔ラベル: `[5分後]`
   - メッセージ: `水を飲む`
3. フッター作成: 削除・更新方法のヘルプ

**出力例**:

```text
📋 あなたのリマインダー（全5件）

ID: f47ac10b
[5分後] 12/25 14:35
💬 水を飲む

ID: b2c3d4e5
[1日後] 12/26 14:30
💬 水を飲む

ID: c3d4e5f6
[3日後] 12/28 14:30
💬 水を飲む

---
削除: 「削除 f47ac10b」
更新: 「更新 f47ac10b 新しいメッセージ」
検索: 「検索 キーワード」
```

## 注意点

### 1. リマインダー件数の上限

- 全リマインダーを1メッセージで表示
- LINE メッセージの文字数上限（5000文字）に注意
- リマインダーが多い場合、メッセージが切れる可能性

**対策案**:

- 件数制限（例: 最大20件まで表示）
- ページネーション（「次へ」ボタンで続きを表示）
- 期限が近いものだけを表示（例: 7日以内）

### 2. ID表示形式

- UUID全体を表示すると長すぎる（36文字）
- 最初の8文字のみ表示（衝突の可能性は低い）
- ユーザーが入力しやすい長さ

**衝突リスク**:

- UUIDv4の最初の8文字（32ビット）の衝突確率は非常に低い
- 同一ユーザー内での衝突であればさらに低い

### 3. 並び順

- `execution_time` の昇順（近い順）
- ユーザーにとって最も関心のあるリマインダーが上位に表示される

### 4. タイムゾーン表示

- 日本時間（Asia/Tokyo）で表示
- フォーマット: `MM/DD HH:mm`
- 年は省略（同年の場合）

### 5. 空リスト対応

リマインダーが0件の場合:

```text
📋 リマインダーがありません

新しいリマインダーを作成するには、
メッセージを送信してください。

例: 水を飲む
→ 5分後、1日後、3日後、7日後、30日後に通知
```

### 6. パフォーマンス

- `getRemindersByUserId()` はインデックス（`idx_reminders_user_id`）を使用
- 1ユーザーあたりのリマインダー数が多い場合でも高速

### 7. メッセージの改行

- リマインダーごとに改行で区切る
- 見やすさのため空行を追加

### 8. 既に期限切れのリマインダー

- 期限切れ（`execution_time < now`）でもまだ削除されていないリマインダーが表示される可能性
- Cron実行が5分ごとなので、最大5分間は期限切れが残る
- 表示時に「期限切れ」マークを付けるかどうか検討

### 9. グループ化表示

- 現在の設計では、同じメッセージの5つのリマインダーは個別に表示される
- groupIdでグループ化して表示する選択肢もある

**例（グループ化あり）**:

```text
📋 水を飲む
├─ [5分後] 12/25 14:35 (ID: f47ac10b)
├─ [1日後] 12/26 14:30 (ID: b2c3d4e5)
├─ [3日後] 12/28 14:30 (ID: c3d4e5f6)
├─ [7日後] 01/01 14:30 (ID: d3e4f5a6)
└─ [30日後] 01/24 14:30 (ID: e4f5a6b7)
```

### 10. コマンド判定の優先順位

- 一覧表示コマンドの判定は、通常のリマインダー作成より優先
- 「一覧」という文字列が新しいリマインダーとして作成されないようにする
