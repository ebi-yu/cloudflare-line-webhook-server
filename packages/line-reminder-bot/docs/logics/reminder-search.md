# リマインダー検索ロジック

## 概要

ユーザーが「検索 [キーワード]」「search [キーワード]」などのコマンドを送信すると、メッセージ内容でリマインダーを検索し、該当するリマインダーのみを表示します。部分一致で検索します。

## エントリーポイント

- **ファイル**: [src/index.ts](../src/index.ts)
- **関数**: `fetch()` ハンドラー
- **トリガー**: LINE Messaging APIからのWebhook（テキストメッセージイベント）
- **判定条件**: メッセージが「検索 」「search 」で始まる（大文字小文字区別なし）
- **キーワード抽出**: コマンド部分（「検索 」「search 」）を除去した残りの文字列

## データフロー

```text
User (LINE)
  │
  │ 1. メッセージ送信 ("検索 水")
  ▼
LINE Messaging API
  │
  │ 2. Webhook POST
  ▼
Cloudflare Workers (index.ts)
  │
  │ 3. Webhook検証・ユーザー認証
  │    メッセージ判定（検索コマンド？）
  │    キーワード抽出
  ▼
reminderSearchUsecase.ts
  │
  │ 4. searchReminders()
  │    ↓
  │    searchRemindersByKeyword()
  ▼
D1 Database
  │
  │ 5. ユーザーのリマインダーをキーワードで部分一致検索
  ▼
reminderSearchUsecase.ts
  │
  │ 6. フォーマット（検索結果メッセージ作成）
  │    - ヒット件数表示
  │    - キーワードをハイライト
  ▼
LINE API (Reply Message)
  │
  │ 7. 検索結果メッセージを返信
  ▼
User (LINE)
```

## 主要関数

### `searchReminders()`

**場所**: [src/usecases/reminderSearchUsecase.ts](../src/usecases/reminderSearchUsecase.ts) (新規作成)

**責務**: キーワードでリマインダーを検索して表示

**パラメータ**:

- `userId`: LINEユーザーID
- `keyword`: 検索キーワード
- `replyToken`: LINE返信用トークン
- `env`: 環境変数

**処理内容**:

1. キーワードが空の場合、エラーメッセージを返信
2. `searchRemindersByKeyword()`で検索実行
3. 検索結果が0件の場合、「見つかりませんでした」を返信
4. 検索結果を整形（一覧表示と同様）
5. `sendReplyToLine()`で結果メッセージを返信

### `searchRemindersByKeyword()`

**場所**: [src/infrastructure/reminderRepository.ts](../src/infrastructure/reminderRepository.ts) (新規追加)

**責務**: メッセージ内容でリマインダーを部分一致検索

**パラメータ**:

- `db`: D1データベースインスタンス
- `userId`: LINEユーザーID
- `keyword`: 検索キーワード

`user_id`と`message`の部分一致で検索し、`execution_time`の昇順で返す。

**戻り値**: `Promise<Reminder[]>`

### `formatSearchResults()`

**場所**: [src/usecases/reminderSearchUsecase.ts](../src/usecases/reminderSearchUsecase.ts) (新規作成)

**責務**: 検索結果を表示用のテキストに整形

**処理内容**:

1. ヘッダー作成: `🔍 検索結果: "キーワード" (N件)`
2. 各リマインダーをループ（一覧表示と同じフォーマット）
3. キーワードを強調表示（可能であれば）

**出力例**:

```text
🔍 検索結果: "水" (5件)

ID: f47ac10b
[5分後] 12/25 14:35
💬 水を飲む

ID: b2c3d4e5
[1日後] 12/26 14:30
💬 水を飲む

ID: a1b2c3d4
[3日後] 12/28 14:30
💬 水やりをする

---
削除: 「削除 f47ac10b」
更新: 「更新 f47ac10b 新しいメッセージ」
```

## 注意点

### 1. キーワード抽出

- コマンド部分（「検索 」「search 」）を除去
- 前後の空白をtrim
- 空キーワードの場合はエラー

**例**:

- 入力: `検索 水` → キーワード: `水`
- 入力: `search water` → キーワード: `water`

### 2. 部分一致検索

- 前後に `%` を付けて部分一致
- 大文字小文字の区別はSQLiteの設定に依存（デフォルトは区別しない）

**マッチ例**:

- キーワード: `水`
- マッチ: `水を飲む`, `水やり`, `薬と水`

### 3. 特殊文字のエスケープ

SQLiteの `LIKE` で特殊な意味を持つ文字:

- `%`: 任意の文字列
- `_`: 任意の1文字

ユーザー入力にこれらが含まれる場合、エスケープが必要。

### 4. 検索対象フィールド

現在の仕様では `message` フィールドのみ検索:

- `message`: リマインドメッセージ内容

**拡張案**:

- `interval_label` も検索対象に含める
- 例: 「検索 1日後」で1日後のリマインダーをすべて取得

### 5. 検索結果の上限

- 一覧表示と同じ問題（LINE メッセージ文字数上限）
- 検索結果が多い場合は件数制限を検討

### 6. 検索パフォーマンス

- `message` フィールドには現在インデックスなし
- 前方一致でないLIKE検索はフルテーブルスキャンになる可能性
- ユーザーごとのリマインダー数が多い場合、パフォーマンスに影響

**対策案**:

- FTS (Full-Text Search) の導入

### 7. 空キーワード対応

キーワードが空の場合のエラーメッセージ:

```text
❌ 検索キーワードを入力してください。

使い方:
検索 キーワード
search キーワード

例:
検索 水
search water
```

### 8. 検索結果0件

該当リマインダーがない場合:

```text
🔍 検索結果: "キーワード" (0件)

該当するリマインダーが見つかりませんでした。

全リマインダーを表示: 「一覧」
```

### 9. 複数キーワード検索

現在の仕様では単一キーワードのみ:

- 入力: `検索 水 薬`
- キーワード: `水 薬` (スペース含む文字列として検索)

**拡張案**:

- スペース区切りで複数キーワードをAND検索

### 10. 日本語・英語対応

- コマンド: `検索` または `search` の両方に対応
- 大文字小文字は区別しない（`Search`, `SEARCH` も可）

### 11. インデックスの追加検討

- 検索頻度が高い場合、`message` へのFTS（Full-Text Search）インデックス追加を検討
- 通常のインデックスは前方一致のみ有効で、中間一致には効果が薄い

### 12. コマンド判定の優先順位

- 検索コマンドの判定は、通常のリマインダー作成より優先
- 「検索 水」という文字列が新しいリマインダーとして作成されないようにする
